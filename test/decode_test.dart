library eth_abi_codec_test.decode_tests;

import 'package:test/test.dart';
import 'package:convert/convert.dart';
import 'package:typed_data/typed_buffers.dart';
import 'package:eth_abi_codec/eth_abi_codec.dart';

Uint8Buffer prepareBuffer(List<String> hexInputs) {
  var buffer = new Uint8Buffer();
  buffer.addAll(hex.decode(hexInputs.join()));
  return buffer;
}

dynamic runDecode(String type, List<String> hexInputs) {
  var buffer = prepareBuffer(hexInputs);
  return decodeType(type, buffer);
}

void main() {
  test('uint256 test', () {
    var r1 = runDecode('uint256', ['0000000000000000000000000000000000000000000000000000000000000001']);
    expect((r1 as BigInt).toInt(), 1);

    var r2 = runDecode('uint256', ['0000000000000000000000000000000000000000000000000000000000000005']);
    expect((r2 as BigInt).toInt(), 5);
  });

  test('string test', () {
    var r1 = runDecode('string', [
      '0000000000000000000000000000000000000000000000000000000000000003',
      '6f6e650000000000000000000000000000000000000000000000000000000000'
    ]);
    expect((r1 as String), "one");

    var r2 = runDecode('string', [
      '0000000000000000000000000000000000000000000000000000000000000005',
      '7468726565000000000000000000000000000000000000000000000000000000'
    ]);
    expect((r2 as String), "three");
  });

  test('address test', () {
    var r1 = runDecode('address', [
      '000000000000000000000000d0a1e359811322d97991e03f863a0c30c2cf029c'
    ]);
    expect((r1 as String), "d0a1e359811322d97991e03f863a0c30c2cf029c");
  });

  test('list test', () {
    var r1 = runDecode('address[]', [
      '0000000000000000000000000000000000000000000000000000000000000002',
      '000000000000000000000000d0a1e359811322d97991e03f863a0c30c2cf029c',
      '000000000000000000000000aaf64bfcc32d0f15873a02163e7e500671a4ffcd'
    ]);
    expect((r1 as List).length, 2);
    expect((r1 as List)[1], 'aaf64bfcc32d0f15873a02163e7e500671a4ffcd');

    var r2 = runDecode('address[]', [
      '0000000000000000000000000000000000000000000000000000000000000000'
    ]);
    expect((r2 as List).length, 0);

    var r3 = runDecode('uint256[]', [
      '0000000000000000000000000000000000000000000000000000000000000003',
      '0000000000000000000000000000000000000000000000000000000000000001',
      '0000000000000000000000000000000000000000000000000000000000000002',
      '0000000000000000000000000000000000000000000000000000000000000003'
    ]);

    expect((r3 as List).length, 3);
    expect((r3 as List)[1], BigInt.from(2));

    var r4 = runDecode('address[2]', [
      '000000000000000000000000d0a1e359811322d97991e03f863a0c30c2cf029c',
      '000000000000000000000000aaf64bfcc32d0f15873a02163e7e500671a4ffcd'
    ]);
    expect((r4 as List).length, 2);
    expect((r4 as List)[1], 'aaf64bfcc32d0f15873a02163e7e500671a4ffcd');
  });

  test('relocate test', () {
    // values ([[1, 2], [3]], ["one", "two", "three"])
    var r1 = runDecode('(uint[][],string[])', [
      '0000000000000000000000000000000000000000000000000000000000000040',
      '0000000000000000000000000000000000000000000000000000000000000140',
      '0000000000000000000000000000000000000000000000000000000000000002',
      '0000000000000000000000000000000000000000000000000000000000000040',
      '00000000000000000000000000000000000000000000000000000000000000a0',
      '0000000000000000000000000000000000000000000000000000000000000002',
      '0000000000000000000000000000000000000000000000000000000000000001',
      '0000000000000000000000000000000000000000000000000000000000000002',
      '0000000000000000000000000000000000000000000000000000000000000001',
      '0000000000000000000000000000000000000000000000000000000000000003',
      '0000000000000000000000000000000000000000000000000000000000000003',
      '0000000000000000000000000000000000000000000000000000000000000060',
      '00000000000000000000000000000000000000000000000000000000000000a0',
      '00000000000000000000000000000000000000000000000000000000000000e0',
      '0000000000000000000000000000000000000000000000000000000000000003',
      '6f6e650000000000000000000000000000000000000000000000000000000000',
      '0000000000000000000000000000000000000000000000000000000000000003',
      '74776f0000000000000000000000000000000000000000000000000000000000',
      '0000000000000000000000000000000000000000000000000000000000000005',
      '7468726565000000000000000000000000000000000000000000000000000000'
    ]);
    expect((r1 as List).length, 2);
    expect(r1[0].length, 2);
    expect(r1[1].length, 3);
    expect(r1[0][0].length, 2);
    expect(r1[0][0][0].toInt(), 1);
    expect(r1[0][0][1].toInt(), 2);
    expect(r1[0][1].length, 1);
    expect(r1[0][1][0].toInt(), 3);
    expect(r1[1][0], "one");
    expect(r1[1][1], "two");
    expect(r1[1][2], "three");
  });
}